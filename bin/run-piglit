#!/bin/bash

exec_short_name=`basename "$0"`

usage()
{
    echo "Usage"
    echo "  $exec_short_name: run tests, archiving by timestamp"
    echo "  $exec_short_name <note>: run tests, archiving by timestamp and note"
    exit 1
}

(( $# <= 1 )) || usage

set -e
platform checkactive
cd "$PLATFORM_ROOT_DIR/piglit"
mkdir -p run
cd run
piglit_run_dir=$PLATFORM_ROOT_DIR/piglit/run
piglit_source_dir=$PLATFORM_ROOT_DIR/piglit/source
num_jobs=`getconf _NPROCESSORS_ONLN`
make "-j$num_jobs"
timestamp=$(date -u +%Y-%m-%d-%H%M%S)
result_dir=$timestamp
if (( $# == 1 )); then
    result_dir=$result_dir-$1
fi
mkdir -p $result_dir
cd $piglit_source_dir
./piglit-run.py tests/quick.tests "$result_dir"
